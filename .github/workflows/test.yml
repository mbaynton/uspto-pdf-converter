name: Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test-ubuntu:
    name: Test on Ubuntu (install-deps.sh)
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: sudo ./install-deps.sh

      - name: Run tests
        run: ./run-tests.sh

  test-macos:
    name: Test on macOS (install-deps.sh)
    runs-on: macos-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: ./install-deps.sh

      - name: Run tests
        run: ./run-tests.sh

  test-fedora-docker:
    name: Test on Fedora (Docker)
    runs-on: ubuntu-latest
    container:
      image: fedora:latest
    timeout-minutes: 20

    steps:
      - name: Install git
        run: dnf install -y git

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: ./install-deps.sh

      - name: Run tests
        run: ./run-tests.sh

  test-windows-docker:
    name: Test on Windows (Docker)
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Build Docker image
        run: docker build --platform linux/amd64 -t uspto-pdf-converter .

      - name: Run tests in Docker container
        shell: bash
        run: |
          # Run full test suite inside Docker on Windows
          docker run --rm \
            -v "$PWD:/work" \
            -w /work \
            uspto-pdf-converter \
            /bin/bash -c "test/bats/bin/bats test/*.bats"

  test-docker-image:
    name: Test Docker Image Build
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: docker build -t uspto-pdf-converter .

      - name: Test Docker image with sample file
        run: |
          # Test with the PDF file from test-files
          docker run --rm \
            -v "$PWD/test-files:/work" \
            uspto-pdf-converter \
            /work/sample.pdf

          # Verify output was created
          if [ -f "test-files/sample.compliant.pdf" ]; then
            echo "✓ Docker conversion successful"
          else
            echo "✗ Docker conversion failed"
            exit 1
          fi

      - name: Validate Docker output
        run: |
          docker run --rm \
            -v "$PWD/test-files:/work" \
            --entrypoint uspto-pdf-validate.sh \
            uspto-pdf-converter \
            /work/sample.compliant.pdf
